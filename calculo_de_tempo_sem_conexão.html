<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<title>Tempo sem Conexão (PDF)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h2 { margin-bottom: 10px; }
  #saida { white-space: pre; background: #f4f4f4; padding: 12px; border-radius: 6px; }
</style>
</head>
<body>
  <h2>Calculadora de Tempo sem Conexão</h2>
  <input type="file" id="file" accept="application/pdf">
  <button onclick="processarPDF()">Processar PDF</button>
  <p id="msg"></p>
  <div id="saida"></div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';

function formatar(segundos) {
  segundos = Math.floor(segundos);
  const dias = Math.floor(segundos / 86400); segundos %= 86400;
  const horas = Math.floor(segundos / 3600); segundos %= 3600;
  const minutos = Math.floor(segundos / 60); const s = segundos % 60;
  let out = "";
  if (dias > 0) out += dias + "d ";
  if (horas > 0) out += horas + "h ";
  if (minutos > 0) out += minutos + "m ";
  out += s + "s";
  return out;
}

async function processarPDF() {
  const file = document.getElementById("file").files[0];
  if (!file) { alert("Selecione um PDF"); return; }

  document.getElementById("msg").textContent = "Lendo PDF...";
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

  let linhas = [];
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    const items = content.items.map(it => it.str).join(" ");
    linhas.push(items);
  }

  const texto = linhas.join("\n");

  // Captura pares de datas dd/mm/yyyy hh:mm:ss
  const regex = /(\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}:\d{2})/g;
  const todasDatas = [...texto.matchAll(regex)].map(m => m[1]);

  // Cada registro tem 2 datas (inicial, final)
  const registros = [];
  for (let i = 0; i < todasDatas.length; i += 2) {
    registros.push({
      inicio: todasDatas[i],
      fim: todasDatas[i+1]
    });
  }

  // Agora calcula intervalo entre fim[i] e inicio[i+1]
  let totalSegundos = 0;
  let detalhes = "";
  for (let i = 0; i < registros.length - 1; i++) {
    const fim = parseDate(registros[i].fim);
    const proxInicio = parseDate(registros[i+1].inicio);
    const diff = (proxInicio - fim) / 1000;
    if (diff > 0) {
      totalSegundos += diff;
      detalhes += `${registros[i].fim} → ${registros[i+1].inicio} = ${formatar(diff)}\n`;
    } else {
      detalhes += `${registros[i].fim} → ${registros[i+1].inicio} = sobreposição\n`;
    }
  }

  detalhes += `\nTOTAL: ${formatar(totalSegundos)} (${totalSegundos} s)`;
  document.getElementById("saida").textContent = detalhes;
  document.getElementById("msg").textContent = "Concluído.";
}

function parseDate(str) {
  // transforma "dd/mm/yyyy hh:mm:ss" em Date
  const [d, m, y, h, mi, s] = str.match(/\d+/g);
  return new Date(`${y}-${m}-${d}T${h}:${mi}:${s}`);
}
</script>

<hr>
<h2>Calculadora de Vencimento</h2>
<label for="vencimento">Data de Vencimento da Fatura:</label>
<input type="date" id="vencimento">
<button onclick="calcularVencimento()">Calcular</button>

<div id="resultadoVencimento"></div>

<script>
function calcularVencimento() {
  const input = document.getElementById("vencimento").value;
  if (!input) {
    alert("Informe a data de vencimento!");
    return;
  }

  const venc = new Date(input + "T00:00:00");
  const hoje = new Date();

  // datas de mudança de status
  const reduzido = new Date(venc); reduzido.setDate(venc.getDate() + 15);
  const bloqueado = new Date(venc); bloqueado.setDate(venc.getDate() + 45);

  const diffDias = Math.floor((hoje - venc) / (1000*60*60*24));
  const faltamReducao = Math.floor((reduzido - hoje) / (1000*60*60*24));
  const faltamBloqueio = Math.floor((bloqueado - hoje) / (1000*60*60*24));

  let status = "";
  let classe = "";

  if (diffDias < 0) {
    status = `Cliente ainda está em dia. Vencimento será em ${Math.abs(diffDias)} dias.`;
    classe = "verde";
  } else if (diffDias < 15) {
    status = `Cliente EM DIA .`;
    classe = "verde";
  } else if (diffDias < 45) {
    status = `Cliente com SINAL REDUZIDO .`;
    classe = "amarelo";
  } else {
    status = `Cliente com SINAL BLOQUEADO .`;
    classe = "vermelho";
  }

  document.getElementById("resultadoVencimento").innerHTML = `
    <p><strong>Data de Vencimento:</strong> ${venc.toLocaleDateString()}</p>
    <p><strong>Data Reduzido (+15 dias):</strong> ${reduzido.toLocaleDateString()} 
       ${faltamReducao > 0 ? `(faltam ${faltamReducao} dias)` : `(há ${Math.abs(faltamReducao)} dias)`}</p>
    <p><strong>Data Bloqueio (+45 dias):</strong> ${bloqueado.toLocaleDateString()} 
       ${faltamBloqueio > 0 ? `(faltam ${faltamBloqueio} dias)` : `(há ${Math.abs(faltamBloqueio)} dias)`}</p>
    <p class="status ${classe}">${status}</p>
  `;
}
</script>

<style>
  .status {
    font-weight: bold;
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    display: inline-block;
  }
  .verde { background: #d4edda; color: #155724; }
  .amarelo { background: #fff3cd; color: #856404; }
  .vermelho { background: #f8d7da; color: #721c24; }
</style>
</script>





</body>
</html>


